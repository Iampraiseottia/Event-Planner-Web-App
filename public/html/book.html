<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Event Planners</title>
    <link rel="stylesheet" href="../css/book.css" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../css/footer.css" />
    <link rel="icon" href="../img/planner1.webp" style="border-radius: 50%" />
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

    <link rel="stylesheet" href="../css/header.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Vercel Web Analytics -->
    <script>
      window.va =
        window.va ||
        function () {
          (window.va.q = window.va.q || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <style>
      @media (max-width: 999px) {
        .header-container {
          padding-left: 60px !important;
        }

        .nav {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 20px !important;
          margin-top: 30px !important;
        }
      }

      @media (min-width: 1000px) {
        .nav {
          visibility: visible !important;
        }
      }

      @media (max-width: 900px) {
        .weddingCel {
          margin-top: 180px !important;
        }
      }
    </style>
  </head>
  <body>
    <!-------------------- Nav Bar ~ Header  ------------------------>

    <section id="header">
      <div class="header-container">
        <h1
          style="
            user-select: none;
            font-size: 30px;
            letter-spacing: 1px;
            font-weight: bold;
          "
        >
          <img
            src="/img/event3.jpg"
            class="home-img"
            style="margin-right: 5px"
          />
          EVENTIFY
          <i
            class="fa-solid fa-x"
            id="close"
            style="cursor: pointer; visibility: hidden; margin-left: 60px"
          ></i>
          <i
            class="fa-solid fa-bars"
            id="menu"
            style="cursor: pointer; visibility: visible"
          ></i>
        </h1>
        <nav class="nav">
          <button
            class="back"
            style="padding: 5px 50px !important; margin-right: 20px !important"
          >
            <a href="../html/customer-dashboard.html">Dashboard</a>
          </button>
          <button class="back" style="padding: 5px 50px !important">
            <a href="../html/category.html">Back To Categories</a>
          </button>
        </nav>
      </div>
    </section>

    <!---------------- BOOK  ------------------------->

    <section id="book">
      <div class="wrapper">
        <div class="borderline">
          <h1>Book An Event Planner</h1>
          <form id="bookingForm">
            <div class="input_box">
              <select name="planner_name" class="planner-name" required>
                <option value="">Choose An Event Planner</option>
                <!-- Options will be populated dynamically -->
              </select>
            </div>

            <div class="input_box">
              <input
                name="customer_name"
                id="name"
                autocomplete="off"
                type="text"
                required
              />
              <label for="text">Your Full Names</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="phone_number"
                id="phone_number"
                autocomplete="off"
                type="number"
                required
              />
              <label for="phone_number">Your Phone Number</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="email"
                id="email"
                autocomplete="off"
                type="email"
                required
              />
              <label for="email">Your Email Address</label>
              <i></i>
            </div>

            <div class="input_box">
              <select name="event_type" class="planner-name" required>
                <option value="">Choose Event Type</option>
                <option value="Wedding Celebrations" style="font-weight: 600">
                  Wedding Celebrations
                </option>
                <option value="Funerals / Memorials" style="font-weight: 600">
                  Funerals / Memorials
                </option>
                <option value="Birthday Celebrations" style="font-weight: 600">
                  Birthday Celebrations
                </option>
                <option
                  value="Anniversary Celebrations"
                  style="font-weight: 600"
                >
                  Anniversary Celebrations
                </option>
              </select>
            </div>

            <div class="input_box">
              <select name="category" class="planner-name" required>
                <option value="">Choose Category ~ Pricing</option>
                <option value="Platinum ~ 2.5M" style="font-weight: 600">
                  Platinum ~ 2.5M
                </option>
                <option value="Diamond ~ 1.5M" style="font-weight: 600">
                  Diamond ~ 1.5M
                </option>
                <option value="Gold ~ 1.0M" style="font-weight: 600">
                  Gold ~ 1.0M
                </option>
                <option value="Bronze ~ 800K" style="font-weight: 600">
                  Bronze ~ 800K
                </option>
                <option value="Silver ~ 500K" style="font-weight: 600">
                  Silver ~ 500K
                </option>
                <option value="High Class ~ 250K" style="font-weight: 600">
                  High Class ~ 250K
                </option>
                <option value="Normal Class ~ 120K" style="font-weight: 600">
                  Normal Class ~ 120K
                </option>
                <option value="Lowest Class ~ 80K" style="font-weight: 600">
                  Lowest Class ~ 80K
                </option>
              </select>
            </div>

            <div class="input_box">
              <input
                name="location"
                id="location"
                autocomplete="off"
                type="text"
                required
              />
              <label for="location">Event Location</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="event_date"
                id="date"
                autocomplete="off"
                type="date"
                required
              />
              <label for="date" style="margin-top: -12px">Event Due Date</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="event_time"
                id="time"
                autocomplete="off"
                type="time"
                required
              />
              <label for="time" style="margin-top: -10px">Event Due Time</label>
              <i></i>
            </div>

            <div class="input_box">
              <textarea
                name="requirements"
                id="order"
                class="order"
                placeholder="Your Requirements In Specificity e.g 500 Chairs, ... etc"
              ></textarea>
            </div>

            <div class="field">
              <input
                type="submit"
                class="btn"
                name="submit"
                value="BOOK NOW!"
                id="bookNow"
                required
              />
            </div>
          </form>
        </div>
      </div>
    </section>

    <div style="margin-top: 50px" class="footer-conclude">
      <p>@Copyright EVENTIFY, All Rights Reserved</p>
      <p>
        <em style="color: rgb(248, 233, 201)">Designed by:</em>
        <strong>Ottia Praise Beteck</strong>
      </p>
    </div>

<script>
// Planner loading functions
async function loadPlanners() {
  try {
    const response = await fetch('/api/bookings/planners', {
      credentials: 'include'
    });
    const data = await response.json();
    
    if (data.success) {
      const plannerSelect = document.querySelector('.planner-name');
      
      // Clear existing options except the first one
      plannerSelect.innerHTML = '<option value="">Choose An Event Planner</option>';
      
      // Add planners from database
      data.planners.forEach(planner => {
        const option = document.createElement('option');
        option.value = planner.full_name;
        option.textContent = planner.full_name;
        option.style.fontWeight = '600';
        
        if (planner.specialty) {
          option.textContent += ` (${planner.specialty})`;
        }

        plannerSelect.appendChild(option);
      });
    } else {
      console.error('Failed to load planners:', data.error);
      loadFallbackPlanners();
    }
  } catch (error) {
    console.error('Error loading planners:', error);
    loadFallbackPlanners();
  }
}

function loadFallbackPlanners() {
  const plannerSelect = document.querySelector('.planner-name');
  const fallbackPlanners = [
    "Deligent Servers",
    "Esther Decor", 
    "MOther Care",
    "Ace Events",
    "Asong Raphael",
    "Le Phenix",
    "Eyamende Raisa",
    "Nkum Brandon",
    "Ncha Philip"
  ];
  
  plannerSelect.innerHTML = '<option value="">Choose An Event Planner</option>';
  
  fallbackPlanners.forEach(plannerName => {
    const option = document.createElement('option');
    option.value = plannerName;
    option.textContent = plannerName;
    option.style.fontWeight = '600';
    plannerSelect.appendChild(option);
  });
}

// Main application logic
document.addEventListener("DOMContentLoaded", function () {
  const bookingForm = document.getElementById("bookingForm");

  // Load planners first
  loadPlanners();

  // Check authentication status
  checkAuthStatus();

  async function checkAuthStatus() {
    try {
      const response = await fetch("/api/auth/status", {
        credentials: "include",
      });
      const data = await response.json();

      if (!data.authenticated) {
        alert("Please login first to book an event planner");
        window.location.href = "/html/login/html";
        return;
      }

      const user = data.user;
      if (user.full_name) {
        document.getElementById("name").value = user.full_name;
      }
      if (user.email) {
        document.getElementById("email").value = user.email;
      }
      if (user.phone_number) {
        document.getElementById("phone_number").value = user.phone_number;
      }

    } catch (error) {
      console.error("Auth check error:", error);
      alert("Please login first to book an event planner");
      window.location.href = "/login";
    }
  }

  bookingForm.addEventListener("submit", async function (e) {
    e.preventDefault();

    const formData = new FormData(bookingForm);
    const bookingData = {
      planner_name: formData.get("planner_name"),
      customer_name: formData.get("customer_name"),
      phone_number: formData.get("phone_number"),
      email: formData.get("email"),
      event_type: formData.get("event_type"),
      category: formData.get("category"),
      location: formData.get("location"),
      event_date: formData.get("event_date"),
      event_time: formData.get("event_time"),
      requirements: formData.get("requirements"),
    };

    try {
      const response = await fetch("/api/bookings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "include",
        body: JSON.stringify(bookingData),
      });

      const data = await response.json();

      if (response.ok) {
        alert("Booking created successfully! We will contact you soon.");
        bookingForm.reset();
        window.location.href = "../html/customer-dashboard.html";
      } else {
        alert(data.error || "Booking failed. Please try again.");
      }
    } catch (error) {
      alert(
        "Booking failed. Please check your connection and try again."
      );
      console.error("Booking error:", error);
    }
  });
});

// Mobile menu functionality - Fixed variable declarations
document.addEventListener("DOMContentLoaded", function() {
  const closeBtn = document.getElementById("close");
  const menuBtn = document.getElementById("menu");
  const navBar = document.querySelector(".nav");
  const header = document.getElementById("header");
  const body = document.body;

  if (menuBtn && closeBtn && navBar) {
    menuBtn.addEventListener("click", () => {
      menuBtn.style.visibility = "hidden";
      closeBtn.style.visibility = "visible";
      navBar.style.visibility = "visible";
      header.classList.add("menu-open");
      body.classList.add("menu-open");
    });

    closeBtn.addEventListener("click", () => {
      menuBtn.style.visibility = "visible";
      closeBtn.style.visibility = "hidden";
      navBar.style.visibility = "hidden";
      header.classList.remove("menu-open");
      body.classList.remove("menu-open");
    });
  }
});
</script>

    <script src="../js/main.js"></script>

    <script>
      const close = document.getElementById("close");
      const menu = document.getElementById("menu");
      const navBar = document.querySelector(".nav");
      const header = document.getElementById("header");
      const body = document.body;

      menu.addEventListener("click", () => {
        menu.style.visibility = "hidden";
        close.style.visibility = "visible";
        navBar.style.visibility = "visible";
        header.classList.add("menu-open");
        body.classList.add("menu-open");
      });

      close.addEventListener("click", () => {
        menu.style.visibility = "visible";
        close.style.visibility = "hidden";
        navBar.style.visibility = "hidden";
        header.classList.remove("menu-open");
        body.classList.remove("menu-open");
      });

      // Populate Planner Dropdown
      async function loadPlanners() {
        try {
          const response = await fetch("/api/bookings/planners", {
            credentials: "include",
          });
          const data = await response.json();

          if (data.success) {
            const plannerSelect = document.querySelector(".planner-name");

            // Clear existing options except the first one
            plannerSelect.innerHTML =
              '<option value="">Choose An Event Planner</option>';

            // Add planners from database
            data.planners.forEach((planner) => {
              const option = document.createElement("option");
              option.value = planner.full_name;
              option.textContent = planner.full_name;
              option.style.fontWeight = "600";

              if (planner.specialty) {
                option.textContent += ` (${planner.specialty})`;
              }

              plannerSelect.appendChild(option);
            });
          } else {
            console.error("Failed to load planners:", data.error);
            loadFallbackPlanners();
          }
        } catch (error) {
          console.error("Error loading planners:", error);
          loadFallbackPlanners();
        }
      }

      function loadFallbackPlanners() {
        const plannerSelect = document.querySelector(".planner-name");
        const fallbackPlanners = [
          "Deligent Servers",
          "Esther Decor",
          "MOther Care",
          "Ace Events",
          "Asong Raphael",
          "Le Phenix",
          "Eyamende Raisa",
          "Nkum Brandon",
          "Ncha Philip",
        ];

        plannerSelect.innerHTML =
          '<option value="">Choose An Event Planner</option>';

        fallbackPlanners.forEach((plannerName) => {
          const option = document.createElement("option");
          option.value = plannerName;
          option.textContent = plannerName;
          option.style.fontWeight = "600";
          plannerSelect.appendChild(option);
        });
      }
    </script>
  </body>
</html>
