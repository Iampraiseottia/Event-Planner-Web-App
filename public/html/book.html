<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Event Planners</title>
    <link rel="stylesheet" href="../css/book.css" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../css/footer.css" />
    <link rel="icon" href="../img/planner1.webp" style="border-radius: 50%" />
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>

    <link rel="stylesheet" href="../css/header.css" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Vercel Web Analytics -->
    <script>
      window.va =
        window.va ||
        function () {
          (window.va.q = window.va.q || []).push(arguments);
        };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <style>
      @media (max-width: 999px) {
        .header-container {
          padding-left: 60px !important;
        }

        .nav {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 20px !important;
          margin-top: 30px !important;
        }
      }

      @media (min-width: 1000px) {
        .nav {
          visibility: visible !important;
        }
      }

      @media (max-width: 900px) {
        .weddingCel {
          margin-top: 180px !important;
        }
      }
      
    </style>
  </head>
  <body>
    <!-------------------- Nav Bar ~ Header  ------------------------>

    <section id="header">
      <div class="header-container">
        <h1
          style="
            user-select: none;
            font-size: 30px;
            letter-spacing: 1px;
            font-weight: bold;
          "
        >
          <img
            src="/img/event3.jpg"
            class="home-img"
            style="margin-right: 5px"
          />
          EVENTIFY
          <i
            class="fa-solid fa-x"
            id="close"
            style="cursor: pointer; visibility: hidden; margin-left: 60px"
          ></i>
          <i
            class="fa-solid fa-bars"
            id="menu"
            style="cursor: pointer; visibility: visible"
          ></i>
        </h1>
        <nav class="nav">
          <button
            class="back"
            style="padding: 5px 50px !important; margin-right: 20px !important"
          >
            <a href="../html/customer-dashboard.html">Dashboard</a>
          </button>
          <button class="back" style="padding: 5px 50px !important">
            <a href="../html/category.html">Back To Categories</a>
          </button>
        </nav>
      </div>
    </section>

    <!---------------- BOOK  ------------------------->

    <section id="book">
      <div class="wrapper">
        <div class="borderline">
          <h1>Book An Event Planner</h1>
          <form id="bookingForm">
            <div class="input_box">
              <select
                name="planner_name"
                class="planner-name"
                required
                disabled
              >
                <option value="">Loading planners...</option>
              </select>
            </div>

            <div class="input_box">
              <input
                name="customer_name"
                id="name"
                autocomplete="off"
                type="text"
                required
              />
              <label for="text">Your Full Names</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="phone_number"
                id="phone_number"
                autocomplete="off"
                type="number"
                required
              />
              <label for="phone_number">Your Phone Number</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="email"
                id="email"
                autocomplete="off"
                type="email"
                required
              />
              <label for="email">Your Email Address</label>
              <i></i>
            </div>

            <div class="input_box">
              <select name="event_type" class="planner-name" required>
                <option value="">Choose Event Type</option>
                <option value="Wedding Celebrations" style="font-weight: 600">
                  Wedding Celebrations
                </option>
                <option value="Funerals / Memorials" style="font-weight: 600">
                  Funerals / Memorials
                </option>
                <option value="Birthday Celebrations" style="font-weight: 600">
                  Birthday Celebrations
                </option>
                <option
                  value="Anniversary Celebrations"
                  style="font-weight: 600"
                >
                  Anniversary Celebrations
                </option>
              </select>
            </div>

            <div class="input_box">
              <select name="category" class="planner-name" required>
                <option value="">Choose Category ~ Pricing</option>
                <option value="Platinum ~ 2.5M" style="font-weight: 600">
                  Platinum ~ 2.5M
                </option>
                <option value="Diamond ~ 1.5M" style="font-weight: 600">
                  Diamond ~ 1.5M
                </option>
                <option value="Gold ~ 1.0M" style="font-weight: 600">
                  Gold ~ 1.0M
                </option>
                <option value="Bronze ~ 800K" style="font-weight: 600">
                  Bronze ~ 800K
                </option>
                <option value="Silver ~ 500K" style="font-weight: 600">
                  Silver ~ 500K
                </option>
                <option value="High Class ~ 250K" style="font-weight: 600">
                  High Class ~ 250K
                </option>
                <option value="Normal Class ~ 120K" style="font-weight: 600">
                  Normal Class ~ 120K
                </option>
                <option value="Lowest Class ~ 80K" style="font-weight: 600">
                  Lowest Class ~ 80K
                </option>
              </select>
            </div>

            <div class="input_box">
              <input
                name="location"
                id="location"
                autocomplete="off"
                type="text"
                required
              />
              <label for="location">Event Location</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="event_date"
                id="date"
                autocomplete="off"
                type="date"
                required
              />
              <label for="date" style="margin-top: -12px">Event Due Date</label>
              <i></i>
            </div>

            <div class="input_box">
              <input
                name="event_time"
                id="time"
                autocomplete="off"
                type="time"
                required
              />
              <label for="time" style="margin-top: -10px">Event Due Time</label>
              <i></i>
            </div>

            <div class="input_box">
              <textarea
                name="requirements"
                id="order"
                class="order"
                placeholder="Your Requirements In Specificity e.g 500 Chairs, ... etc"
              ></textarea>
            </div>

            <div class="field">
              <input
                type="submit"
                class="btn"
                name="submit"
                value="BOOK NOW!"
                id="bookNow"
                required
              />
            </div>
          </form>
        </div>
      </div>
    </section>

    <div style="margin-top: 50px" class="footer-conclude">
      <p>@Copyright EVENTIFY, All Rights Reserved</p>
      <p>
        <em style="color: rgb(248, 233, 201)">Designed by:</em>
        <strong>Ottia Praise Beteck</strong>
      </p>
    </div>

    <script>

    let isFormSubmitting = false;

      // Load planners from database
      async function loadPlanners() {
        const plannerSelect = document.querySelector(".planner-name");

        if (!plannerSelect) {
          console.error("Planner select element not found");
          return;
        }

        try {
          console.log("Loading planners from database...");

          // Show loading state
          plannerSelect.innerHTML =
            '<option value="" class="loading-planners">Loading planners...</option>';
          plannerSelect.disabled = true;

          const response = await fetch("/api/bookings/planners", {
            method: "GET",
            credentials: "include",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
          });

          console.log("Response status:", response.status);

          if (!response.ok) {
            let errorMessage = `HTTP ${response.status}`;
            try {
              const errorData = await response.json();
              errorMessage =
                errorData.error || errorData.message || errorMessage;
              console.error("Server error response:", errorData);
            } catch (parseError) {
              console.error("Could not parse error response:", parseError);
              errorMessage = `HTTP ${response.status} - ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          console.log("Planners data received:", data);

          plannerSelect.innerHTML =
            '<option value="">Choose An Event Planner</option>';
          plannerSelect.disabled = false;

          // Check if we have planners data
          if (data.success && data.planners && Array.isArray(data.planners)) {
            if (data.planners.length > 0) {
              data.planners.forEach((planner) => {
                const option = document.createElement("option");
                option.value = planner.full_name;
                option.style.fontWeight = "600";
                option.dataset.plannerId = planner.id;

                let displayText = planner.full_name;

                if (planner.rating && planner.rating > 0) {
                  displayText += ` - ${planner.rating.toFixed(1)}★`;
                }

                option.textContent = displayText;
                plannerSelect.appendChild(option);
              });

              console.log(
                `Successfully loaded ${data.planners.length} planners from database`
              );
            } else {
              // No planners found in database
              console.warn("No planners found in database");
              const option = document.createElement("option");
              option.value = "";
              option.textContent = "No event planners available at the moment";
              option.disabled = true;
              option.className = "no-planners";
              plannerSelect.appendChild(option);
            }
          } else {
            throw new Error("Invalid response format from server");
          }
        } catch (error) {
          console.error("Error loading planners:", error);

          // Show error state
          plannerSelect.disabled = false;
          plannerSelect.innerHTML =
            '<option value="">Choose An Event Planner</option>';

          // Error option
          const errorOption = document.createElement("option");
          errorOption.value = "";
          errorOption.disabled = true;
          errorOption.className = "error-planners";
          errorOption.textContent = `Error: ${error.message}`;
          plannerSelect.appendChild(errorOption);

          // Retry option
          const retryOption = document.createElement("option");
          retryOption.value = "";
          retryOption.textContent = "🔄 Click here to retry loading planners";
          retryOption.className = "error-planners";
          retryOption.style.cursor = "pointer";
          plannerSelect.appendChild(retryOption);

          // Retry functionality
          plannerSelect.addEventListener("change", function retryHandler(e) {
            if (
              e.target.value === "" &&
              e.target.selectedOptions[0]?.textContent.includes("retry")
            ) {
              plannerSelect.removeEventListener("change", retryHandler);
              loadPlanners();
            }
          });
        }
      }

      // Check authentication status and populate user data
      async function checkAuthStatus() {
        try {
          const response = await fetch("/api/auth/status", {
            credentials: "include",
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (!data.authenticated) {
            alert("Please login first to book an event planner");
            window.location.href = "/html/login.html";
            return;
          }

          // Populate user data if available
          const user = data.user;
          if (user) {
            if (user.full_name) {
              document.getElementById("name").value = user.full_name;
            }
            if (user.email) {
              document.getElementById("email").value = user.email;
            }
            if (user.phone_number) {
              document.getElementById("phone_number").value = user.phone_number;
            }
          }
        } catch (error) {
          console.error("Auth check error:", error);
          alert("Please login first to book an event planner");
          window.location.href = "/html/login.html";
        }
      }

      // Handle booking form submission
      async function handleBookingSubmit(e) {
        e.preventDefault();

        if (isFormSubmitting) {
          console.log("Form already submitting, ignoring duplicate submit");
          return;
        }

        isFormSubmitting = true;
        console.log("Form submitted");

        // Show loading state on button
        const submitBtn = document.getElementById("bookNow");
        const originalText = submitBtn.value;
        submitBtn.value = "Booking...";
        submitBtn.disabled = true;

        try {
          const formData = new FormData(e.target);
          const bookingData = {
            planner_name: formData.get("planner_name"),
            customer_name: formData.get("customer_name"),
            phone_number: formData.get("phone_number"),
            email: formData.get("email"),
            event_type: formData.get("event_type"),
            category: formData.get("category"),
            location: formData.get("location"),
            event_date: formData.get("event_date"),
            event_time: formData.get("event_time"),
            requirements: formData.get("requirements"),
          };

          console.log("Booking data to submit:", bookingData);

          // Validate required fields on frontend
          const requiredFields = [
            "planner_name",
            "customer_name",
            "phone_number",
            "email",
            "event_type",
            "category",
            "location",
            "event_date",
            "event_time",
          ];

          const missingFields = requiredFields.filter(
            (field) => !bookingData[field] || bookingData[field].trim() === ""
          );

          if (missingFields.length > 0) {
            alert(
              `Please fill in all required fields: ${missingFields.join(", ")}`
            );
            return;
          }

          // Validate date is not in the past
          const eventDate = new Date(bookingData.event_date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          if (eventDate < today) {
            alert("Event date cannot be in the past");
            return;
          }

          const response = await fetch("/api/bookings", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include",
            body: JSON.stringify(bookingData),
          });

          const data = await response.json();
          console.log("Server response:", data);

          if (response.ok) {
            // Show success popup
            showSuccessPopup();
            e.target.reset(); 

            await loadPlanners();
          } else {
            alert(data.error || "Booking failed. Please try again.");
            console.error("Booking error:", data);
          }
        } catch (error) {
          alert("Booking failed. Please check your connection and try again.");
          console.error("Booking submission error:", error);
        } finally {
          // Reset button state and form submission flag
          submitBtn.value = originalText;
          submitBtn.disabled = false;
          isFormSubmitting = false;
        }
      }

      // Success popup functions
      function showSuccessPopup() {
        // Create popup HTML
        const popupHTML = `
          <div id="successPopup" class="success-popup-overlay">
            <div class="success-popup">
              <div class="success-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h2>Booking Successful!</h2>
              <p>Thank you for choosing EVENTIFY! Your booking has been submitted successfully.</p>
              <p>Our team will contact you soon to confirm the details.</p>
              <div class="popup-actions">
                <button onclick="closeSuccessPopup()" class="btn-primary">Close</button>
              </div>
              <div class="auto-redirect-info">
                <p>Redirecting to dashboard in <span id="countdown">60</span> seconds...</p>
              </div>
            </div>
          </div>
        `;

        // Adding Popup to body
        document.body.insertAdjacentHTML("beforeend", popupHTML);

        // Start countdown
        let timeLeft = 60;
        const countdownEl = document.getElementById("countdown");

        const countdownTimer = setInterval(() => {
          timeLeft--;
          if (countdownEl) {
            countdownEl.textContent = timeLeft;
          }

          if (timeLeft <= 0) {
            clearInterval(countdownTimer);
            redirectToDashboard();
          }
        }, 1000);

        window.successPopupTimer = countdownTimer;
      }

      function closeSuccessPopup() {
        // Clear timer if exists
        if (window.successPopupTimer) {
          clearInterval(window.successPopupTimer);
        }

        const popup = document.getElementById("successPopup");
        if (popup) {
          popup.remove();
        }

        redirectToDashboard();
      }

      function redirectToDashboard() {
        window.location.href = "../html/customer-dashboard.html";
      }

      // Mobile menu functionality
      function initializeMobileMenu() {
        const closeBtn = document.getElementById("close");
        const menuBtn = document.getElementById("menu");
        const navBar = document.querySelector(".nav");
        const header = document.getElementById("header");
        const body = document.body;

        if (menuBtn && closeBtn && navBar) {
          menuBtn.addEventListener("click", () => {
            menuBtn.style.visibility = "hidden";
            closeBtn.style.visibility = "visible";
            navBar.style.visibility = "visible";
            header.classList.add("menu-open");
            body.classList.add("menu-open");
          });

          closeBtn.addEventListener("click", () => {
            menuBtn.style.visibility = "visible";
            closeBtn.style.visibility = "hidden";
            navBar.style.visibility = "hidden";
            header.classList.remove("menu-open");
            body.classList.remove("menu-open");
          });
        }
      }

      // Main initialization
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("DOM Content Loaded");

        const bookingForm = document.getElementById("bookingForm");

        if (!bookingForm) {
          console.error("Booking form not found");
          return;
        }

        initializeMobileMenu();

        await checkAuthStatus();

        await loadPlanners();

        // Submit form
        bookingForm.addEventListener("submit", handleBookingSubmit);

        console.log("Initialization completed");
      });

      window.closeSuccessPopup = closeSuccessPopup;
      window.redirectToDashboard = redirectToDashboard;

    </script>

    <script src="../js/main.js"></script>




    <!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/689141d1fcd547192ddd8490/1j1rmi73k';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->

  </body>
</html>
